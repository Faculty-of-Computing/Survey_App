{% extends 'base.html' %} {% block title %} Verify Email {% endblock %} {% block
content%}

<div
  class="bg-gradient-to-br from-gray-100 to-white min-h-screen flex items-center justify-center"
>
  <div class="bg-white shadow-lg rounded-2xl w-full max-w-sm p-8 space-y-6">
    <!-- Icon -->
    <div class="flex justify-center">
      <div
        class="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center"
      >
        <!-- Simple icon (clipboard emoji) -->
        <span class="text-2xl">ðŸ“‹</span>
      </div>
    </div>

    <!-- Toggle Tabs -->
    <div
      class="flex justify-center items-center bg-gray-200 rounded-md py-2 text-xl"
    >
      <div class="text-black">OTP Sent Successfully!</div>
    </div>

    <!-- Form -->
    <form
      class="space-y-4"
      method="POST"
      action="{{ url_for('auth.verify_otp_form') }}"
    >
      {% if error %}
      <div
        class="bg-red-100 border border-red-400 text-red-700 px-4 py-2 rounded relative text-sm mb-2"
        role="alert"
      >
        {{ error }}
      </div>
      {% endif %}
      <div>
        <input
          type="number"
          name="otp"
          id="otpInput"
          class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400"
          required
        />
      </div>
      <div class="flex justify-between items-center">
        <button
          data-url="{{ url_for('auth.resend_otp') }}"
          id="resendOtpButton"
          type="button"
          class="p-2 bg-black text-white rounded-md hover:bg-gray-900 transition hover:shadow-sm"
        >
          <span
            class="text-sm hover:underline cursor-pointer"
            id="countdownSpan"
          >
            Resend OTP
          </span>
        </button>
        <button
          type="submit"
          class="p-2 bg-black text-white rounded-md hover:bg-gray-900 transition hover:shadow-sm"
          id="submitButton"
        >
          Done
        </button>
      </div>
    </form>
  </div>
</div>

{% endblock %} {% block js %}

<script>
  const resendOtpButton = document.getElementById("resendOtpButton");
  let duration = {{ remaining_time | tojson }}; // from Flask
  const countdownElement = document.getElementById("countdownSpan");
  let timer = null; // keep reference to clear later

  //Countdown Logic
  function startCountdown() {
    if (timer) clearInterval(timer); // clear any old timer

    timer = setInterval(() => {
      const minutes = Math.floor(duration / 60);
      const seconds = duration % 60;

      countdownElement.textContent = `Resend in ${minutes
        .toString()
        .padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;

      if (--duration < 0) {
        clearInterval(timer);
        countdownElement.textContent = "Resend OTP";
        resendOtpButton.disabled = false;
      } else {
        resendOtpButton.disabled = true;
      }
    }, 1000);
  }

  //resendOtpButton Event Listener and Logic
  document.addEventListener("DOMContentLoaded", () => {
    resendOtpButton.disabled = duration > 0;
    if (duration > 0) {
      startCountdown();
    }

    // âœ… Handle resend click
    resendOtpButton.addEventListener("click", () => {
      fetch(resendOtpButton.dataset.url, { method: "POST" }) // Flask route
        .then((res) => {
          if (!res.ok) throw new Error("Failed to resend OTP");
          return res.json();
        })
        .then((data) => {
          // Reset countdown for another 5 minutes
          duration = 300; // 5 mins
          startCountdown();
        })
        .catch((err) => {
          console.error(err);
          alert("Something went wrong while resending OTP!");
        });
    });

    // OTP input validation
    const otpInput = document.getElementById("otpInput");
    otpInput.addEventListener("input", () => {
      if (otpInput.value.length === 6) {
        otpInput.classList.remove("border-red-500");
        otpInput.classList.add("border-green-500");
      } else {
        otpInput.classList.remove("border-green-500");
        otpInput.classList.add("border-red-500");
      }
    });
  });
</script>

{% endblock %}
