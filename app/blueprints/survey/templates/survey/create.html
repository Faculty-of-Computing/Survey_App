{% extends 'base.html' %} {% block title %}Create Survey{% endblock %} {% block
content %}
<!-- Header -->
<div class="w-full border-b border-gray-300 bg-white">
  <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
    <div class="flex items-center space-x-2">
      <a
        href="{{ url_for('survey.dashboard') }}"
        class="text-sm text-black hover:underline hover:bg-black hover:text-white px-3 py-2 rounded"
        >üîô Back</a
      >
      <div>
        <h1 class="text-lg font-semibold">Create Survey</h1>
        <p class="text-sm text-gray-500">Build your survey step by step</p>
      </div>
    </div>
    <button
      id="save-survey-btn"
      class="bg-black text-white px-4 py-2 rounded-md hover:bg-gray-800"
    >
      Save Survey
    </button>
  </div>
</div>
<div class="max-w-4xl mx-auto p-6">
  <!-- Survey Info -->
  <div class="bg-white p-6 rounded shadow mb-6">
    <h2 class="text-lg font-semibold mb-1">Survey Information</h2>
    <form id="survey-info-form">
      <label class="block mb-4">
        <span class="text-sm font-medium">Survey Title</span>
        <input
          id="survey-title"
          name="survey_title"
          type="text"
          class="w-full mt-1 p-2 border border-gray-300 rounded"
          placeholder="Enter survey title"
        />
      </label>
      <label class="block mb-4">
        <span class="text-sm font-medium">Description</span>
        <textarea
          id="survey-description"
          name="survey_description"
          class="w-full mt-1 p-2 border border-gray-300 rounded"
          placeholder="Describe what this survey is about"
        ></textarea>
      </label>
      <label class="flex items-center">
        <input
          id="publish-toggle"
          name="publish"
          type="checkbox"
          class="mr-2"
        />
        <span class="text-sm">Publish immediately</span>
      </label>
    </form>
  </div>
  <!-- Questions Section -->
  <div class="bg-white rounded shadow mb-6">
    <div
      class="flex justify-between items-center border-b border-gray-200 px-6 py-4"
    >
      <h2 class="text-md font-semibold">Questions</h2>
      <button
        id="add-question-btn"
        class="bg-black text-white px-4 py-2 rounded-md text-sm hover:bg-gray-800"
      >
        + Add Question
      </button>
    </div>
    <!-- Empty State -->
    <div
      id="empty-state"
      class="flex flex-col items-center justify-center text-gray-400 py-12"
    >
      <div class="text-4xl">+</div>
      <p class="mt-2 text-sm font-medium text-black">No questions yet</p>
      <p class="text-xs text-gray-500 mb-4">
        Add your first question to get started
      </p>
      <button
        id="empty-add-btn"
        class="bg-black text-white px-4 py-2 rounded-md text-sm hover:bg-gray-800"
      >
        + Add Question
      </button>
    </div>
    <!-- Questions Container -->
    <div id="questions-container" class="p-6 hidden">
      <!-- initial template block removed: JS will inject all question blocks -->
    </div>
  </div>
</div>
{% endblock %} {% block js %}
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const container = document.getElementById("questions-container");
    const addBtns = document.querySelectorAll(
      "#add-question-btn, #empty-add-btn"
    );
    const emptyState = document.getElementById("empty-state");
    const saveBtn = document.getElementById("save-survey-btn");

    addBtns.forEach((btn) => btn.addEventListener("click", addNewQuestion));

    function toggleEmptyState() {
      const has = container.children.length > 0;
      emptyState.classList.toggle("hidden", has);
      container.classList.toggle("hidden", !has);
    }

    function updateNumbers() {
      container.querySelectorAll(".question-block").forEach((blk, i) => {
        blk.querySelector(".question-number").textContent = `Question ${i + 1}`;
      });
    }

    function attachEvents(block) {
      block
        .querySelector('input[name="question_text"]')
        .addEventListener("input", () => {});
      block.querySelector(".delete-btn").addEventListener("click", () => {
        block.remove();
        updateNumbers();
        toggleEmptyState();
      });
      block
        .querySelector('select[name="question_type"]')
        .addEventListener("change", (e) => {
          const cfg = block.querySelector(".file-config");
          if (e.target.value === "File Upload") {
            if (!cfg) {
              const d = document.createElement("div");
              d.className = "file-config mt-4";
              d.innerHTML = `<label class='block text-sm font-medium'>Allowed File Types<input name='file_types' type='text' class='w-full mt-1 border rounded px-3 py-2' placeholder='.jpg, .png'/></label>
            <label class='block text-sm font-medium mt-2'>Max File Size (MB)<input name='max_size' type='number' class='w-full mt-1 border rounded px-3 py-2' placeholder='10'/></label>`;
              block.append(d);
            }
          } else if (cfg) cfg.remove();
        });
    }

    function addNewQuestion() {
      const blk = document.createElement("div");
      blk.className =
        "question-block border border-gray-300 p-4 rounded-md mb-5";
      blk.innerHTML = `
      <div class='flex justify-between items-center mb-3'>
        <h3 class='question-number text-lg font-medium'>Question</h3>
        <button type='button' class='delete-btn text-gray-500 hover:text-red-500 text-xl cursor-pointer'>üóëÔ∏è</button>
      </div>
      <label class='block text-sm font-medium'>Question Text<input name='question_text' type='text' class='question-text w-full mt-1 border rounded px-3 py-2' placeholder='Enter question'/></label>
      <label class='block text-sm font-medium mt-4'>Question Type<select name='question_type' class='question-type w-full mt-1 border rounded px-3 py-2'>
        <option>Text Response</option>
        <option>Multiple Choice</option>
        <option>Rating (1‚Äì5)</option>
        <option>Slider/Range</option>
        <option>File Upload</option>
      </select></label>
      <label class='flex items-center mt-4'>
        <input name='question_required' type='checkbox' class='mr-2' />
        <span class='text-sm'>Required</span>
      </label>
    `;
      container.append(blk);
      attachEvents(blk);
      updateNumbers();
      toggleEmptyState();
    }

    function collectData() {
      const info = {
        title: document.getElementById("survey-title").value,
        description: document.getElementById("survey-description").value,
        publish: document.getElementById("publish-toggle").checked,
      };
      const qs = [];
      container.querySelectorAll(".question-block").forEach((blk) => {
        const text = blk.querySelector('input[name="question_text"]').value;
        const type = blk.querySelector('select[name="question_type"]').value;
        const req = blk.querySelector(
          'input[name="question_required"]'
        ).checked;
        const q = { text, type, required: req };
        const cfg = blk.querySelector(".file-config");
        if (type === "File Upload" && cfg) {
          q.allowed_types = cfg
            .querySelector('input[name="file_types"]')
            .value.split(",")
            .map((s) => s.trim());
          q.max_size_mb = parseInt(
            cfg.querySelector('input[name="max_size"]').value,
            10
          );
        }
        qs.push(q);
      });
      fetch("/survey/save", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ info, questions: qs }),
      })
        .then((response) => {
          if (!response.ok) {
            return response.text().then((text) => {
              console.error("Server Error Response:", text);
              throw new Error(`Server responded with ${response.status}`);
            });
          }
          return response.json();
        })
        .then((json) => {
          alert("Survey " + json.survey_id + " saved");
        })
        .catch((error) => {
          console.error("Fetch Error:", error);
          alert("An error occurred: " + error.message);
        });
    }

    saveBtn.addEventListener("click", collectData);
    toggleEmptyState();
  });
</script>
{% endblock %}
